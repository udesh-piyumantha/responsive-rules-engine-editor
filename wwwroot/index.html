<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rules Engine Editor - Manage Microsoft Rules Engine Workflows</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .sidebar {
            width: 320px;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
        }

        .workflow-item {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

            .workflow-item:hover {
                background-color: rgba(255, 255, 255, 0.05);
            }

            .workflow-item.active {
                background-color: rgba(59, 130, 246, 0.2);
                border-left-color: #3b82f6;
            }

        .rule-item {
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

            .rule-item:hover {
                border-color: #3b82f6;
                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
            }

        .global-param-item {
            background-color: #f8fafc;
            border-left: 3px solid #10b981;
        }

        .ace_editor {
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .tab {
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

            .tab:hover {
                color: #3b82f6;
            }

            .tab.active {
                color: #3b82f6;
                border-bottom-color: #3b82f6;
            }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-primary {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .badge-success {
            background-color: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background-color: #fef3c7;
            color: #92400e;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }

        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <div class="mr-4">
                        <i class="fas fa-code-branch text-2xl text-blue-600"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Rules Engine Editor</h1>
                        <p class="text-sm text-gray-600">Manage Microsoft Rules Engine workflows with Inventory.API</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Storage Provider</label>
                        <select id="storageProvider" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="jsonfile">JSON File</option>
                            <option value="s3">AWS S3</option>
                            <option value="azureblob">Azure Blob</option>
                        </select>
                    </div>
                    <button onclick="loadWorkflows()" class="inline-flex items-center px-4 py-2 bg-gray-100 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-sync-alt mr-2"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex">
        <!-- Sidebar -->
        <div class="sidebar h-screen overflow-y-auto">
            <div class="p-6">
                <h2 class="text-lg font-semibold text-white mb-4">Workflows</h2>
                <button onclick="openNewWorkflowModal()" class="w-full mb-4 inline-flex items-center justify-center px-4 py-2 bg-blue-600 border border-transparent rounded-md font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i class="fas fa-plus mr-2"></i> New Workflow
                </button>

                <div id="workflowList" class="space-y-2">
                    <!-- Workflows will be loaded here -->
                </div>

                <div id="loadingWorkflows" class="text-center py-4">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
                    <p class="mt-2 text-gray-400">Loading workflows...</p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 h-screen overflow-y-auto">
            <!-- Empty State -->
            <div id="emptyState" class="p-8">
                <div class="max-w-lg mx-auto text-center py-16">
                    <div class="mx-auto flex items-center justify-center h-24 w-24 rounded-full bg-blue-100 mb-6">
                        <i class="fas fa-file-code text-4xl text-blue-600"></i>
                    </div>
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-4">No Workflow Selected</h2>
                    <p class="text-lg text-gray-600 mb-8">Select a workflow from the sidebar or create a new one to start editing rules.</p>
                    <button onclick="openNewWorkflowModal()" class="inline-flex items-center px-6 py-3 bg-blue-600 border border-transparent rounded-md font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-plus mr-2"></i> Create Your First Workflow
                    </button>
                </div>
            </div>

            <!-- Editor -->
            <div id="editorContainer" class="hidden">
                <div class="bg-white border-b">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex justify-between items-center py-4">
                            <div>
                                <h2 id="workflowName" class="text-2xl font-bold text-gray-900"></h2>
                                <p id="workflowDescription" class="text-gray-600"></p>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="saveWorkflow()" class="inline-flex items-center px-4 py-2 bg-green-600 border border-transparent rounded-md font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    <i class="fas fa-save mr-2"></i> Save Workflow
                                </button>
                                <button onclick="showDeleteConfirm()" class="inline-flex items-center px-4 py-2 bg-red-600 border border-transparent rounded-md font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                    <i class="fas fa-trash mr-2"></i> Delete
                                </button>
                            </div>
                        </div>

                        <!-- Tabs -->
                        <div class="border-b border-gray-200">
                            <nav class="-mb-px flex space-x-8">
                                <button onclick="switchTab('form')" class="tab py-4 px-1 text-sm font-medium">
                                    <i class="fas fa-edit mr-2"></i> Form Editor
                                </button>
                                <button onclick="switchTab('json')" class="tab py-4 px-1 text-sm font-medium">
                                    <i class="fas fa-code mr-2"></i> JSON Editor
                                </button>
                                <button onclick="switchTab('test')" class="tab py-4 px-1 text-sm font-medium">
                                    <i class="fas fa-vial mr-2"></i> Test Rules
                                </button>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Form Tab -->
                <div id="formTab" class="tab-content p-8">
                    <div class="max-w-7xl mx-auto">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <!-- Workflow Info -->
                            <div class="lg:col-span-1">
                                <div class="bg-white rounded-lg shadow p-6">
                                    <h3 class="text-lg font-medium text-gray-900 mb-4">Workflow Information</h3>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Workflow Name</label>
                                            <input type="text" id="workflowNameInput" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Description</label>
                                            <textarea id="workflowDescInput" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Global Parameters -->
                                <div class="bg-white rounded-lg shadow p-6 mt-6">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="text-lg font-medium text-gray-900">Global Parameters</h3>
                                        <button onclick="openNewGlobalParamModal()" class="inline-flex items-center px-3 py-1 bg-blue-100 border border-transparent rounded-md text-sm font-medium text-blue-700 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            <i class="fas fa-plus mr-1"></i> Add Parameter
                                        </button>
                                    </div>
                                    <div id="globalParamsContainer" class="space-y-3">
                                        <!-- Global parameters will be loaded here -->
                                    </div>
                                    <div id="noGlobalParams" class="text-center py-4 text-gray-500">
                                        <i class="fas fa-sliders-h text-2xl mb-2"></i>
                                        <p>No global parameters added yet</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Rules -->
                            <div class="lg:col-span-2">
                                <div class="bg-white rounded-lg shadow p-6">
                                    <div class="flex justify-between items-center mb-6">
                                        <h3 class="text-lg font-medium text-gray-900">Rules</h3>
                                        <div class="flex space-x-3">
                                            <button onclick="openNewRuleModal()" class="inline-flex items-center px-4 py-2 bg-blue-600 border border-transparent rounded-md font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                                <i class="fas fa-plus mr-2"></i> Add Rule
                                            </button>
                                            <button onclick="showRulesExamples()" class="inline-flex items-center px-4 py-2 bg-gray-100 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                                <i class="fas fa-lightbulb mr-2"></i> Examples
                                            </button>
                                        </div>
                                    </div>

                                    <div id="rulesContainer" class="space-y-4">
                                        <!-- Rules will be loaded here -->
                                    </div>

                                    <div id="noRules" class="text-center py-8">
                                        <i class="fas fa-list-alt text-4xl text-gray-300 mb-4"></i>
                                        <h4 class="text-lg font-medium text-gray-900 mb-2">No Rules Yet</h4>
                                        <p class="text-gray-600 mb-4">Rules define the logic of your workflow</p>
                                        <button onclick="openNewRuleModal()" class="inline-flex items-center px-4 py-2 bg-blue-600 border border-transparent rounded-md font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            <i class="fas fa-plus mr-2"></i> Create Your First Rule
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- JSON Tab -->
                <div id="jsonTab" class="tab-content hidden p-8">
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-lg shadow">
                            <div class="px-6 py-4 border-b border-gray-200">
                                <div class="flex justify-between items-center">
                                    <h3 class="text-lg font-medium text-gray-900">JSON Editor</h3>
                                    <div class="flex space-x-3">
                                        <button onclick="formatJson()" class="inline-flex items-center px-3 py-1 bg-gray-100 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            <i class="fas fa-align-left mr-1"></i> Format
                                        </button>
                                        <button onclick="validateJson()" class="inline-flex items-center px-3 py-1 bg-yellow-100 border border-yellow-300 rounded-md text-sm font-medium text-yellow-700 hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                                            <i class="fas fa-check-circle mr-1"></i> Validate
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="p-6">
                                <textarea id="jsonEditor" rows="25" class="w-full font-mono text-sm border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Tab -->
                <div id="testTab" class="tab-content hidden p-8">
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-6">Test Rules</h3>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <!-- Input Section -->
                                <div>
                                    <h4 class="font-medium text-gray-700 mb-4">Test Input</h4>
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Sample Input (JSON)</label>
                                        <textarea id="testInput" rows="12" class="w-full font-mono text-sm border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">{
  "unitPrice": 100.50,
  "quantity": 5,
  "company": "ABC",
  "category": "Electronics",
  "totalAmount": 502.50
}</textarea>
                                    </div>
                                    <button onclick="testRules()" class="w-full inline-flex items-center justify-center px-4 py-2 bg-blue-600 border border-transparent rounded-md font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <i class="fas fa-play mr-2"></i> Test Rules
                                    </button>
                                </div>

                                <!-- Results Section -->
                                <div>
                                    <h4 class="font-medium text-gray-700 mb-4">Test Results</h4>
                                    <div id="testResults" class="p-4 bg-gray-50 rounded-lg">
                                        <div class="text-center py-8 text-gray-500">
                                            <i class="fas fa-chart-bar text-3xl mb-2"></i>
                                            <p>Run a test to see results here</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- New Workflow Modal -->
    <div id="newWorkflowModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-md">
            <div class="bg-white rounded-lg shadow-xl">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Create New Workflow</h3>
                </div>
                <div class="px-6 py-4">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Workflow Name</label>
                            <input type="text" id="newWorkflowName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., TaxCalculation">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Description</label>
                            <textarea id="newWorkflowDesc" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Describe what this workflow does..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 rounded-b-lg flex justify-end space-x-3">
                    <button onclick="closeNewWorkflowModal()" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Cancel</button>
                    <button onclick="createNewWorkflow()" class="px-4 py-2 bg-blue-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Create Workflow</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Rule Modal -->
    <div id="newRuleModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-2xl">
            <div class="bg-white rounded-lg shadow-xl">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Add New Rule</h3>
                </div>
                <div class="px-6 py-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Rule Name</label>
                            <input type="text" id="newRuleName" class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., CheckOrderAmount">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Success Event</label>
                            <input type="text" id="newRuleSuccess" class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., OrderApproved">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Condition (Lambda Expression)</label>
                        <textarea id="newRuleCondition" rows="3" class="w-full font-mono text-sm border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., input1.Amount > 1000"></textarea>
                        <p class="mt-1 text-sm text-gray-500">Use <code class="bg-gray-100 px-1 rounded">input1</code> to reference input parameters</p>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Error Message</label>
                        <input type="text" id="newRuleError" class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Order amount is too high">
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Examples</label>
                        <div class="text-sm text-gray-600 space-y-1">
                            <div class="cursor-pointer hover:bg-gray-50 p-2 rounded" onclick="document.getElementById('newRuleCondition').value = 'input1.Amount > 1000'">
                                <code class="text-blue-600">input1.Amount > 1000</code> - Check if amount exceeds 1000
                            </div>
                            <div class="cursor-pointer hover:bg-gray-50 p-2 rounded" onclick="document.getElementById('newRuleCondition').value = 'input1.Company == \" ABC\" && input1.Category= =\"Electronics\"'">
                                <code class="text-blue-600">input1.Company == "ABC" && input1.Category == "Electronics"</code> - Check company and category
                            </div>
                            <div class="cursor-pointer hover:bg-gray-50 p-2 rounded" onclick="document.getElementById('newRuleCondition').value = 'input1.UnitPrice * input1.Quantity > 500'">
                                <code class="text-blue-600">input1.UnitPrice * input1.Quantity > 500</code> - Calculate total and check threshold
                            </div>
                        </div>
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 rounded-b-lg flex justify-end space-x-3">
                    <button onclick="closeNewRuleModal()" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Cancel</button>
                    <button onclick="createNewRule()" class="px-4 py-2 bg-blue-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Add Rule</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Global Parameter Modal -->
    <div id="newGlobalParamModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-md">
            <div class="bg-white rounded-lg shadow-xl">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Add Global Parameter</h3>
                </div>
                <div class="px-6 py-4">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Parameter Name</label>
                            <input type="text" id="newParamName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., TaxRate">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Expression/Value</label>
                            <input type="text" id="newParamExpression" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 0.18">
                            <p class="mt-1 text-sm text-gray-500">Use numeric values (0.18), boolean (true/false), or string expressions</p>
                        </div>
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 rounded-b-lg flex justify-end space-x-3">
                    <button onclick="closeNewGlobalParamModal()" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Cancel</button>
                    <button onclick="createNewGlobalParam()" class="px-4 py-2 bg-blue-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Add Parameter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div id="deleteConfirmModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-md">
            <div class="bg-white rounded-lg shadow-xl">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Confirm Delete</h3>
                </div>
                <div class="px-6 py-4">
                    <p class="text-gray-700">Are you sure you want to delete <span id="deleteWorkflowName" class="font-semibold"></span>?</p>
                    <p class="mt-2 text-sm text-gray-500">This action cannot be undone.</p>
                </div>
                <div class="px-6 py-4 bg-gray-50 rounded-b-lg flex justify-end space-x-3">
                    <button onclick="closeDeleteConfirm()" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Cancel</button>
                    <button onclick="deleteWorkflow()" class="px-4 py-2 bg-red-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Toast -->
    <div id="alertToast" class="fixed top-4 right-4 z-50 hidden">
        <div class="rounded-lg shadow-lg p-4 max-w-sm" id="alertContent">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <i id="alertIcon" class="fas fa-info-circle text-lg"></i>
                </div>
                <div class="ml-3">
                    <p id="alertMessage" class="text-sm font-medium"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let currentWorkflow = null;
        let currentWorkflowData = null;
        let workflows = [];

        // DOM Elements
        const elements = {
            emptyState: document.getElementById('emptyState'),
            editorContainer: document.getElementById('editorContainer'),
            workflowList: document.getElementById('workflowList'),
            loadingWorkflows: document.getElementById('loadingWorkflows'),
            workflowName: document.getElementById('workflowName'),
            workflowDescription: document.getElementById('workflowDescription'),
            workflowNameInput: document.getElementById('workflowNameInput'),
            workflowDescInput: document.getElementById('workflowDescInput'),
            rulesContainer: document.getElementById('rulesContainer'),
            noRules: document.getElementById('noRules'),
            globalParamsContainer: document.getElementById('globalParamsContainer'),
            noGlobalParams: document.getElementById('noGlobalParams'),
            jsonEditor: document.getElementById('jsonEditor'),
            testInput: document.getElementById('testInput'),
            testResults: document.getElementById('testResults')
        };

        // API Base URL
        const API_BASE_URL = '/api/Rules';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadWorkflows();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Sync JSON editor with form changes
            elements.workflowNameInput.addEventListener('input', updateJsonEditor);
            elements.workflowDescInput.addEventListener('input', updateJsonEditor);
            elements.jsonEditor.addEventListener('input', () => {
                try {
                    const json = JSON.parse(elements.jsonEditor.value);
                    syncFormFromJson(json);
                } catch (e) {
                    // Ignore JSON errors while typing
                }
            });
        }

        // Workflow Management
        async function loadWorkflows() {
            showLoading();
            try {
                const provider = document.getElementById('storageProvider').value;
                const response = await fetch(`${API_BASE_URL}/workflows?provider=${provider}`);
                const data = await response.json();

                if (data.success) {
                    workflows = data.data || [];
                    renderWorkflowList();
                } else {
                    showAlert('Failed to load workflows: ' + (data.errors?.[0] || data.message), 'error');
                }
            } catch (error) {
                console.error('Error loading workflows:', error);
                showAlert('Error loading workflows: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function renderWorkflowList() {
            elements.workflowList.innerHTML = '';

            if (workflows.length === 0) {
                elements.workflowList.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-inbox text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-400">No workflows found</p>
                        </div>
                    `;
                return;
            }

            workflows.forEach(workflow => {
                const workflowElement = document.createElement('div');
                workflowElement.className = `workflow-item p-4 rounded-lg cursor-pointer ${currentWorkflow?.name === workflow.name ? 'active' : ''}`;
                workflowElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-medium text-white">${workflow.name}</h3>
                                <p class="text-sm text-gray-400 mt-1">${workflow.description || 'No description'}</p>
                            </div>
                            <div class="flex space-x-2">
                                <span class="badge badge-primary">
                                    <i class="fas fa-list mr-1"></i> ${workflow.ruleCount}
                                </span>
                                ${workflow.globalParamCount > 0 ? `
                                    <span class="badge badge-success">
                                        <i class="fas fa-sliders-h mr-1"></i> ${workflow.globalParamCount}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                        <div class="mt-2 text-xs text-gray-400">
                            Updated: ${new Date(workflow.updatedAt).toLocaleDateString()}
                        </div>
                    `;
                workflowElement.onclick = () => selectWorkflow(workflow.name);
                elements.workflowList.appendChild(workflowElement);
            });
        }

        async function selectWorkflow(name) {
            showLoading();
            try {
                const provider = document.getElementById('storageProvider').value;
                const response = await fetch(`${API_BASE_URL}/workflows/${name}?provider=${provider}`);
                const data = await response.json();

                if (data.success) {
                    currentWorkflow = name;
                    currentWorkflowData = data.data;
                    renderEditor();
                } else {
                    showAlert('Failed to load workflow: ' + (data.errors?.[0] || data.message), 'error');
                }
            } catch (error) {
                console.error('Error loading workflow:', error);
                showAlert('Error loading workflow: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function renderEditor() {
            elements.emptyState.classList.add('hidden');
            elements.editorContainer.classList.remove('hidden');

            // Update header
            elements.workflowName.textContent = currentWorkflowData.name;
            elements.workflowDescription.textContent = currentWorkflowData.description || 'No description provided';

            // Update form fields
            elements.workflowNameInput.value = currentWorkflowData.name;
            elements.workflowDescInput.value = currentWorkflowData.description || '';

            // Render rules
            renderRules();

            // Render global parameters
            renderGlobalParams();

            // Update JSON editor
            updateJsonEditor();

            // Switch to form tab
            switchTab('form');
        }

        function renderRules() {
            const rules = currentWorkflowData.rules || [];

            if (rules.length === 0) {
                elements.rulesContainer.classList.add('hidden');
                elements.noRules.classList.remove('hidden');
                return;
            }

            elements.noRules.classList.add('hidden');
            elements.rulesContainer.classList.remove('hidden');
            elements.rulesContainer.innerHTML = '';

            rules.forEach((rule, index) => {
                const ruleElement = document.createElement('div');
                ruleElement.className = 'rule-item bg-white border rounded-lg p-4';
                ruleElement.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-medium text-gray-900">${rule.name || 'Unnamed Rule'}</h4>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span class="badge badge-primary">
                                        <i class="fas fa-bolt mr-1"></i> ${rule.ruleExpressionType || 'LambdaExpression'}
                                    </span>
                                    ${rule.successEvent ? `
                                        <span class="badge badge-success">
                                            <i class="fas fa-check mr-1"></i> ${rule.successEvent}
                                        </span>
                                    ` : ''}
                                    <span class="text-xs text-gray-500">
                                        ${rule.enabled ? 'Enabled' : 'Disabled'}
                                    </span>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editRule(${index})" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteRule(${index})" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Condition</label>
                            <div class="font-mono text-sm bg-gray-50 p-3 rounded border">
                                ${rule.expression || 'No condition specified'}
                            </div>
                        </div>
                        ${rule.errorMessage ? `
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Error Message</label>
                                <p class="text-sm text-gray-600">${rule.errorMessage}</p>
                            </div>
                        ` : ''}
                    `;
                elements.rulesContainer.appendChild(ruleElement);
            });
        }

        function renderGlobalParams() {
            const params = currentWorkflowData.globalParams || [];

            if (params.length === 0) {
                elements.globalParamsContainer.classList.add('hidden');
                elements.noGlobalParams.classList.remove('hidden');
                return;
            }

            elements.noGlobalParams.classList.add('hidden');
            elements.globalParamsContainer.classList.remove('hidden');
            elements.globalParamsContainer.innerHTML = '';

            params.forEach((param, index) => {
                const paramElement = document.createElement('div');
                paramElement.className = 'global-param-item p-3 rounded';
                paramElement.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="font-medium text-gray-900">${param.name}</span>
                                <div class="text-sm text-gray-600 mt-1">
                                    <code class="bg-gray-100 px-2 py-1 rounded">${param.expression}</code>
                                </div>
                            </div>
                            <button onclick="deleteGlobalParam(${index})" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                elements.globalParamsContainer.appendChild(paramElement);
            });
        }

        // Rule Management
        function openNewRuleModal() {
            document.getElementById('newRuleName').value = '';
            document.getElementById('newRuleCondition').value = '';
            document.getElementById('newRuleSuccess').value = '';
            document.getElementById('newRuleError').value = '';
            document.getElementById('newRuleModal').classList.remove('hidden');
        }

        function closeNewRuleModal() {
            document.getElementById('newRuleModal').classList.add('hidden');
        }

        function createNewRule() {
            const name = document.getElementById('newRuleName').value.trim();
            const condition = document.getElementById('newRuleCondition').value.trim();
            const successEvent = document.getElementById('newRuleSuccess').value.trim();
            const errorMessage = document.getElementById('newRuleError').value.trim();

            if (!name) {
                showAlert('Rule name is required', 'warning');
                return;
            }

            if (!condition) {
                showAlert('Condition is required', 'warning');
                return;
            }

            const newRule = {
                name: name,
                expression: condition,
                successEvent: successEvent || name + 'Success',
                errorMessage: errorMessage || `Rule '${name}' failed`,
                ruleExpressionType: 'LambdaExpression',
                enabled: true
            };

            if (!currentWorkflowData.rules) {
                currentWorkflowData.rules = [];
            }
            currentWorkflowData.rules.push(newRule);

            renderRules();
            updateJsonEditor();
            closeNewRuleModal();
            showAlert('Rule added successfully', 'success');
        }

        function editRule(index) {
            const rule = currentWorkflowData.rules[index];
            document.getElementById('newRuleName').value = rule.name;
            document.getElementById('newRuleCondition').value = rule.expression;
            document.getElementById('newRuleSuccess').value = rule.successEvent || '';
            document.getElementById('newRuleError').value = rule.errorMessage || '';

            // Temporarily store the index
            document.getElementById('newRuleModal').dataset.editIndex = index;

            // Change modal title
            document.querySelector('#newRuleModal h3').textContent = 'Edit Rule';

            document.getElementById('newRuleModal').classList.remove('hidden');

            // Update create button text
            const createBtn = document.querySelector('#newRuleModal button[onclick="createNewRule()"]');
            createBtn.textContent = 'Update Rule';
            createBtn.onclick = updateRule;
        }

        function updateRule() {
            const index = parseInt(document.getElementById('newRuleModal').dataset.editIndex);
            const name = document.getElementById('newRuleName').value.trim();
            const condition = document.getElementById('newRuleCondition').value.trim();
            const successEvent = document.getElementById('newRuleSuccess').value.trim();
            const errorMessage = document.getElementById('newRuleError').value.trim();

            if (!name || !condition) {
                showAlert('Name and condition are required', 'warning');
                return;
            }

            currentWorkflowData.rules[index] = {
                ...currentWorkflowData.rules[index],
                name: name,
                expression: condition,
                successEvent: successEvent || name + 'Success',
                errorMessage: errorMessage || `Rule '${name}' failed`
            };

            renderRules();
            updateJsonEditor();
            closeNewRuleModal();
            showAlert('Rule updated successfully', 'success');
        }

        function deleteRule(index) {
            if (confirm('Are you sure you want to delete this rule?')) {
                currentWorkflowData.rules.splice(index, 1);
                renderRules();
                updateJsonEditor();
                showAlert('Rule deleted successfully', 'success');
            }
        }

        // Global Parameter Management
        function openNewGlobalParamModal() {
            document.getElementById('newParamName').value = '';
            document.getElementById('newParamExpression').value = '';
            document.getElementById('newGlobalParamModal').classList.remove('hidden');
        }

        function closeNewGlobalParamModal() {
            document.getElementById('newGlobalParamModal').classList.add('hidden');
        }

        function createNewGlobalParam() {
            const name = document.getElementById('newParamName').value.trim();
            const expression = document.getElementById('newParamExpression').value.trim();

            if (!name) {
                showAlert('Parameter name is required', 'warning');
                return;
            }

            if (!expression) {
                showAlert('Expression is required', 'warning');
                return;
            }

            if (!currentWorkflowData.globalParams) {
                currentWorkflowData.globalParams = [];
            }

            currentWorkflowData.globalParams.push({
                name: name,
                expression: expression
            });

            renderGlobalParams();
            updateJsonEditor();
            closeNewGlobalParamModal();
            showAlert('Global parameter added successfully', 'success');
        }

        function deleteGlobalParam(index) {
            if (confirm('Are you sure you want to delete this parameter?')) {
                currentWorkflowData.globalParams.splice(index, 1);
                renderGlobalParams();
                updateJsonEditor();
                showAlert('Global parameter deleted successfully', 'success');
            }
        }

        // JSON Editor Functions
        function updateJsonEditor() {
            const workflowData = {
                name: elements.workflowNameInput.value,
                description: elements.workflowDescInput.value,
                rules: currentWorkflowData?.rules || [],
                globalParams: currentWorkflowData?.globalParams || [],
                createdAt: currentWorkflowData?.createdAt || new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            currentWorkflowData = workflowData;
            elements.jsonEditor.value = JSON.stringify(workflowData, null, 2);
        }

        function syncFormFromJson(json) {
            if (json.name) elements.workflowNameInput.value = json.name;
            if (json.description) elements.workflowDescInput.value = json.description;
            if (json.rules) currentWorkflowData.rules = json.rules;
            if (json.globalParams) currentWorkflowData.globalParams = json.globalParams;

            renderRules();
            renderGlobalParams();
        }

        function formatJson() {
            try {
                const parsed = JSON.parse(elements.jsonEditor.value);
                elements.jsonEditor.value = JSON.stringify(parsed, null, 2);
                showAlert('JSON formatted successfully', 'success');
            } catch (e) {
                showAlert('Invalid JSON: ' + e.message, 'error');
            }
        }

        function validateJson() {
            try {
                JSON.parse(elements.jsonEditor.value);
                showAlert('JSON is valid', 'success');
            } catch (e) {
                showAlert('Invalid JSON: ' + e.message, 'error');
            }
        }

        // Workflow Operations
        async function saveWorkflow() {
            if (!currentWorkflowData) return;

            const workflowData = {
                name: currentWorkflowData.name,
                description: currentWorkflowData.description || '',
                rules: currentWorkflowData.rules || [],
                globalParams: currentWorkflowData.globalParams || []
            };

            try {
                const provider = document.getElementById('storageProvider').value;
                const response = await fetch(`${API_BASE_URL}/workflows?provider=${provider}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(workflowData)
                });

                const data = await response.json();
                if (data.success) {
                    showAlert('Workflow saved successfully', 'success');
                    loadWorkflows(); // Refresh list
                } else {
                    showAlert('Failed to save workflow: ' + (data.errors?.[0] || data.message), 'error');
                }
            } catch (error) {
                console.error('Error saving workflow:', error);
                showAlert('Error saving workflow: ' + error.message, 'error');
            }
        }

        function showDeleteConfirm() {
            if (!currentWorkflow) return;
            document.getElementById('deleteWorkflowName').textContent = currentWorkflow;
            document.getElementById('deleteConfirmModal').classList.remove('hidden');
        }

        function closeDeleteConfirm() {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
        }

        async function deleteWorkflow() {
            try {
                const provider = document.getElementById('storageProvider').value;
                const response = await fetch(`${API_BASE_URL}/workflows/${currentWorkflow}?provider=${provider}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    showAlert('Workflow deleted successfully', 'success');
                    closeDeleteConfirm();
                    currentWorkflow = null;
                    currentWorkflowData = null;
                    elements.editorContainer.classList.add('hidden');
                    elements.emptyState.classList.remove('hidden');
                    loadWorkflows();
                } else {
                    showAlert('Failed to delete workflow: ' + (data.errors?.[0] || data.message), 'error');
                }
            } catch (error) {
                console.error('Error deleting workflow:', error);
                showAlert('Error deleting workflow: ' + error.message, 'error');
            }
        }

        // New Workflow Modal
        function openNewWorkflowModal() {
            document.getElementById('newWorkflowName').value = '';
            document.getElementById('newWorkflowDesc').value = '';
            document.getElementById('newWorkflowModal').classList.remove('hidden');
        }

        function closeNewWorkflowModal() {
            document.getElementById('newWorkflowModal').classList.add('hidden');
        }

        async function createNewWorkflow() {
            const name = document.getElementById('newWorkflowName').value.trim();
            const description = document.getElementById('newWorkflowDesc').value.trim();

            if (!name) {
                showAlert('Workflow name is required', 'warning');
                return;
            }

            const workflowData = {
                name: name,
                description: description,
                rules: [],
                globalParams: []
            };

            try {
                const provider = document.getElementById('storageProvider').value;
                const response = await fetch(`${API_BASE_URL}/workflows?provider=${provider}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(workflowData)
                });

                const data = await response.json();
                if (data.success) {
                    showAlert('Workflow created successfully', 'success');
                    closeNewWorkflowModal();
                    loadWorkflows();
                    // Select the new workflow
                    setTimeout(() => selectWorkflow(name), 500);
                } else {
                    showAlert('Failed to create workflow: ' + (data.errors?.[0] || data.message), 'error');
                }
            } catch (error) {
                console.error('Error creating workflow:', error);
                showAlert('Error creating workflow: ' + error.message, 'error');
            }
        }

        // Test Rules
        async function testRules() {
            try {
                const input = JSON.parse(elements.testInput.value);

                // This would normally call your Inventory.API to test the rules
                // For now, we'll simulate a response
                const simulatedResults = currentWorkflowData?.rules?.map(rule => ({
                    ruleName: rule.name,
                    isSuccess: Math.random() > 0.5,
                    output: Math.random() > 0.5 ? 'Test passed' : 'Test failed',
                    executedAt: new Date().toISOString()
                })) || [];

                elements.testResults.innerHTML = `
                        <h5 class="font-medium text-gray-900 mb-3">Test Results for "${currentWorkflowData?.name}"</h5>
                        <div class="space-y-3">
                            ${simulatedResults.map(result => `
                                <div class="p-3 rounded ${result.isSuccess ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="font-medium ${result.isSuccess ? 'text-green-800' : 'text-red-800'}">
                                            ${result.ruleName}
                                        </span>
                                        <span class="badge ${result.isSuccess ? 'badge-success' : 'badge-warning'}">
                                            ${result.isSuccess ? 'PASSED' : 'FAILED'}
                                        </span>
                                    </div>
                                    <div class="text-sm ${result.isSuccess ? 'text-green-700' : 'text-red-700'}">
                                        ${result.output}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;

                showAlert('Test completed successfully', 'success');
            } catch (error) {
                showAlert('Invalid test input: ' + error.message, 'error');
            }
        }

        // UI Helpers
        function switchTab(tabName) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll(`[onclick="switchTab('${tabName}')"]`).forEach(tab => tab.classList.add('active'));

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
        }

        function showRulesExamples() {
            alert('Rule Examples:\n\n' +
                '1. Check order amount: input1.Amount > 1000\n' +
                '2. Validate company: input1.Company == "ABC"\n' +
                '3. Check inventory: input1.CurrentStock < input1.MinimumStockLevel\n' +
                '4. Tax calculation: input1.UnitPrice * 0.18');
        }

        function showAlert(message, type = 'info') {
            const alertToast = document.getElementById('alertToast');
            const alertContent = document.getElementById('alertContent');
            const alertIcon = document.getElementById('alertIcon');
            const alertMessage = document.getElementById('alertMessage');

            // Set type-specific styles
            let bgColor = 'bg-blue-50';
            let borderColor = 'border-blue-200';
            let iconColor = 'text-blue-400';
            let icon = 'fa-info-circle';

            if (type === 'success') {
                bgColor = 'bg-green-50';
                borderColor = 'border-green-200';
                iconColor = 'text-green-400';
                icon = 'fa-check-circle';
            } else if (type === 'warning') {
                bgColor = 'bg-yellow-50';
                borderColor = 'border-yellow-200';
                iconColor = 'text-yellow-400';
                icon = 'fa-exclamation-triangle';
            } else if (type === 'error') {
                bgColor = 'bg-red-50';
                borderColor = 'border-red-200';
                iconColor = 'text-red-400';
                icon = 'fa-times-circle';
            }

            alertContent.className = `rounded-lg shadow-lg p-4 max-w-sm border ${bgColor} ${borderColor}`;
            alertIcon.className = `fas ${icon} text-lg ${iconColor}`;
            alertMessage.textContent = message;
            alertMessage.className = 'text-sm font-medium ' +
                (type === 'success' ? 'text-green-800' :
                    type === 'warning' ? 'text-yellow-800' :
                        type === 'error' ? 'text-red-800' : 'text-blue-800');

            alertToast.classList.remove('hidden');

            // Auto-hide after 5 seconds
            setTimeout(() => {
                alertToast.classList.add('hidden');
            }, 5000);
        }

        function showLoading() {
            elements.loadingWorkflows.classList.remove('hidden');
        }

        function hideLoading() {
            elements.loadingWorkflows.classList.add('hidden');
        }
    </script>
</body>
</html>